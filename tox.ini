[tox]
envlist =
    py{312}-buildhtml
requires =
    pip >= 19.3.1

[testenv]

description = run tests and build html

passenv = CI, CIRCLECI, GITHUB_EVENT_NAME, GITHUB_EVENT_PATH

deps =
    # Notebook content dependencies
    -rcrossmatch/requirements_ztf_ps1_crossmatch.txt
#    -rforced_photometry/requirements_multiband_photometry.txt
#    -rlight_curves/requirements_light_curve_collector.txt
    -rlight_curves/requirements_scale_up.txt
    -rlight_curves/requirements_light_curve_classifier.txt
    -rlight_curves/requirements_ML_AGNzoo.txt
    -rspectroscopy/requirements_spectra_collector.txt
    # Notebook infrastructure requirements
    -rgeneric_requirements.txt
    # We use these files to specify all the dependencies, and below we override
    # versions for specific testing scenarios
    buildhtml: -rsite-requirements.txt


allowlist_externals =
    bash, jupyter-book

commands =
    pip freeze

    # Ignore some notebooks for various types of testing. The individual lists are stored in the `ignore_tutorials`
    # directory and are documented about the specific reasons of them included in the ignores.
    # These files are kept under version control.
    # The files `ignore_testing` and `ignore_execution` are generated during the CI jobs and are not under version control.

    buildhtml: bash -c 'cat ignore_tutorials/ignore_rendering >> ignore_testing'

    # sed -i needs a bit of hacky conditional on ubuntu to cover the case of an empty ignore
    buildhtml: bash -c "find . -name '*md' | grep -f ignore_testing | sort | uniq > ignore_execute; if [ -s ignore_execute ]; then cat ignore_execute | xargs -n 1 sed -i -e 's|name: python3|name: python3\nskip_execution: true|g';fi"

    buildhtml: jupyter-book build --execute --html
    buildhtml: bash -c "rm _build/html/*thebe*.js"

skip_install = true
