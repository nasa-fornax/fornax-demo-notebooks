
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Cross-Match ZTF and Pan-STARRS using LSDB &#8212; Fornax Demo Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'crossmatch/ztf_ps1_crossmatch';</script>
    <link rel="icon" href="../_static/fornax_favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Cross Matching" href="README.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/fornax_logo.png" class="logo__image only-light" alt="Fornax Demo Notebooks - Home"/>
    <script>document.write(`<img src="../_static/fornax_logo.png" class="logo__image only-dark" alt="Fornax Demo Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/nasa-fornax/fornax-demo-notebooks" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    The Fornax Initiative
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorial Notebooks</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../forced_photometry/README.html">Multi-band forced photometry</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../forced_photometry/multiband_photometry.html">Automated Multiband Forced Photometry on Large Datasets</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../light_curves/README.html">Time Domain</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../light_curves/light_curve_collector.html">Make Multi-Wavelength Light Curves Using Archival Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../light_curves/scale_up.html">Make Multi-Wavelength Light Curves for Large Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../light_curves/light_curve_classifier.html">Light Curve Classifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../light_curves/ML_AGNzoo.html">AGN Zoo: Comparison of AGN selected with different metrics</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../spectroscopy/README.html">Spectroscopy</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../spectroscopy/spectra_collector.html">Extract Multi-Wavelength Spectroscopy from Archival Data</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="README.html">Cross Matching</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Cross-Match ZTF and Pan-STARRS using LSDB</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/nasa-fornax/fornax-demo-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/nasa-fornax/fornax-demo-notebooks/issues/new?title=Issue%20on%20page%20%2Fcrossmatch/ztf_ps1_crossmatch.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/crossmatch/ztf_ps1_crossmatch.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Cross-Match ZTF and Pan-STARRS using LSDB</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#runtime">Runtime</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preconfiguring-the-run">1. Preconfiguring the Run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-catalogs-and-downselect-ztf-to-nrows">2. Read in catalogs and downselect ZTF to Nrows</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialize-the-crossmatch-and-compute-measuring-the-time-elapsed">3. Initialize the crossmatch and compute, measuring the time elapsed.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#record-and-plot-benchmarks">4. Record and plot benchmarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">5. Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="cross-match-ztf-and-pan-starrs-using-lsdb">
<h1>Cross-Match ZTF and Pan-STARRS using LSDB<a class="headerlink" href="#cross-match-ztf-and-pan-starrs-using-lsdb" title="Link to this heading">#</a></h1>
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h2>
<p>By the end of this tutorial, you will:</p>
<ul class="simple">
<li><p>understand how to cross-match cloud-based catalogs using <code class="docutils literal notranslate"><span class="pre">lsdb</span></code>.</p></li>
<li><p>understand how to parallelize <code class="docutils literal notranslate"><span class="pre">lsdb</span></code> cross-matches using <code class="docutils literal notranslate"><span class="pre">dask</span></code>.</p></li>
<li><p>have a feeling for when <code class="docutils literal notranslate"><span class="pre">dask</span></code> parallelization can be helpful.</p></li>
<li><p>have a rough idea of the maximum number of objects that can be cross matched on each Fornax Science Console server type.</p></li>
</ul>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>In the era of increasingly large astronomical survey missions like TESS, Gaia, ZTF, Pan-STARRS, Roman, and Rubin, catalog operations are becoming less and less practical to complete on a personal computer. Operations such as source cross-matching can require many GB of memory and take many hours to complete using a single CPU. Recognizing these looming obstacles, many catalogs are becoming accessible to cloud computing platforms like the Fornax Science Console, and increasingly high-performance tools are being developed that leverage cloud computing resources to simplify and speed up catalog operations.</p>
<p><a class="reference external" href="https://lsdb.io">LSDB</a> is a useful package for performing large cross-matches between HATS catalogs. It can leverage the <a class="reference external" href="https://www.dask.org/">Dask</a> library to work with larger-than-memory data sets and distribute computation tasks across multiple cores. Users perform large cross-matches without ever having to download a file.</p>
<p>In this tutorial, we will use <code class="docutils literal notranslate"><span class="pre">lsdb</span></code> with <code class="docutils literal notranslate"><span class="pre">dask</span></code> to perform a cross-match between ZTF and Pan-STARRS HATS catalogs to benchmark the performance. These HATS catalogs are stored on AWS S3 cloud storage. An application might be to collect time-series photometry for 10,000 or more stars in the Kepler field from ZTF and Pan-STARRS. With this in mind, we will begin by cross-matching 10,000 sources from ZTF with the Pan-STARRS mean-object catalog. The user can choose to scale up to a larger number of rows to test the performance. The CSV file provided with this notebook contains the runtime results of tests run on various Fornax Science Console server types for comparison.</p>
<p>As of August 2025, the Fornax Science Console server types were:</p>
<ul class="simple">
<li><p>“Small” - 4 GB RAM, 2 CPU</p></li>
<li><p>“Medium” - 16 GB RAM, 4 CPU</p></li>
<li><p>“Large” -  64 GB RAM, 16 CPU</p></li>
<li><p>“XLarge” -  512 GB RAM, 128 CPU</p></li>
</ul>
<p>For generality, we will refer to the server type by the number of CPUs. For each server and each number of cross-match rows, we want to know the performance with (1) default <code class="docutils literal notranslate"><span class="pre">dask</span></code> configuration, (2) minimal <code class="docutils literal notranslate"><span class="pre">dask</span></code> - 1 worker, (3) bigger <code class="docutils literal notranslate"><span class="pre">dask</span></code> - as many workers as we can use, and (4) auto-scaling <code class="docutils literal notranslate"><span class="pre">dask</span></code>.</p>
<p><strong>Note</strong> that in this notebook, only one configuration (combination of CPU count, number of cross-match rows, and <code class="docutils literal notranslate"><span class="pre">dask</span></code> configuration) is run at a time. It must be reconfigured and rerun to benchmark each configuration.</p>
<section id="runtime">
<h3>Runtime<a class="headerlink" href="#runtime" title="Link to this heading">#</a></h3>
<p>As of August 2025, as written (10,000 rows with the “default” <code class="docutils literal notranslate"><span class="pre">dask</span></code> settings), this notebook takes about 45 seconds to run on the “small” Fornax Science Console server type (4 GB RAM and 2 CPUs). Users can modify the configuration for larger cross-matches, which will take more time. E.g., cross-matching 10 million rows on the “large” server type (64 GB RAM and 16 CPUs) can take ~5 minutes.</p>
</section>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h2>
<p>We require the following packages:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">os</span></code> solely for the <code class="docutils literal notranslate"><span class="pre">cpu_count</span></code> function,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">datetime</span></code> for measuring the crossmatch time,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pandas</span></code> to write and read the CSV of benchmarks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> to plot the benchmarks,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy</span></code> for coordinates and units,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lsdb</span></code> to read the catalogs and perform the cross-match, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dask</span></code> for parallelization.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment the next line to install dependencies if needed.</span>
<span class="c1"># %pip install -r requirements_ztf_ps1_crossmatch.txt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">cpu_count</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lsdb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lsdb.core.search</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConeSearch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">LocalCluster</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="preconfiguring-the-run">
<h2>1. Preconfiguring the Run<a class="headerlink" href="#preconfiguring-the-run" title="Link to this heading">#</a></h2>
<p>First choose the number of rows we want to cross-match and our <code class="docutils literal notranslate"><span class="pre">dask</span></code> environment. For tips on using <code class="docutils literal notranslate"><span class="pre">dask</span></code> with <code class="docutils literal notranslate"><span class="pre">lsdb</span></code>, see <a class="reference external" href="https://docs.lsdb.io/en/stable/tutorials/dask-cluster-tips.html"><code class="docutils literal notranslate"><span class="pre">lsdb</span></code>’s Dask Cluster Tips</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The left table will have about this many rows. The cross-matched product will have slightly fewer.</span>
<span class="c1"># Set Nrows = -1 to cross-match the entire catalog. The full catalog cross-match is</span>
<span class="c1"># recommended ONLY on XLarge instance with at least 32 workers.</span>
<span class="n">Nrows</span> <span class="o">=</span> <span class="mi">10_000</span>

<span class="c1"># dask_workers can be:</span>
<span class="c1"># - &quot;default&quot; (uses the default scheduler which runs all tasks in the main process)</span>
<span class="c1"># - an integer, which uses a fixed number of workers</span>
<span class="c1"># - &quot;scale&quot; to use an adaptive, auto-scaling cluster.</span>
<span class="n">dask_workers</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The code in this cell is automatic setup based on the configuration in the previous cell, so it can be left alone.</span>

<span class="c1"># We must pass a radius to lsdb. Here is the mapping between radius and desired number of rows for ZTF.</span>
<span class="c1"># The values in this dictionary were determined experimentally, by</span>
<span class="c1"># incrementing/decrementing the radius until the desired number of</span>
<span class="c1"># catalog rows was returned.</span>
<span class="n">radius</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># Nrows: radius_arcseconds</span>
           <span class="mi">10_000</span><span class="p">:</span>     <span class="mi">331</span><span class="p">,</span>
          <span class="mi">100_000</span><span class="p">:</span>    <span class="mi">1047</span><span class="p">,</span>
        <span class="mi">1_000_000</span><span class="p">:</span>    <span class="mi">3318</span><span class="p">,</span>
       <span class="mi">10_000_000</span><span class="p">:</span>  <span class="mi">11_180</span><span class="p">,</span>
      <span class="mi">100_000_000</span><span class="p">:</span>  <span class="mi">33_743</span><span class="p">,</span>
    <span class="mi">1_000_000_000</span><span class="p">:</span> <span class="mi">102_000</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Set up dask cluster</span>
<span class="k">if</span> <span class="n">dask_workers</span> <span class="o">==</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">()</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">minimum_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum_cores</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">())</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dask_workers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span>
        <span class="c1"># Number of Dask workers - Python processes to run</span>
        <span class="n">n_workers</span><span class="o">=</span><span class="n">dask_workers</span><span class="p">,</span>
        <span class="c1"># Limits number of Python threads per worker</span>
        <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="c1"># Memory limit per worker</span>
        <span class="n">memory_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">elif</span> <span class="n">dask_workers</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
    <span class="c1"># Either using default configuration or configuring Dask</span>
    <span class="c1"># using the built-in DaskHub</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`dask_workers` must be one of &#39;default&#39;, &#39;scale&#39; or an int.&quot;</span><span class="p">)</span>

<span class="c1"># The performance may depend on the number of CPUs available, so we&#39;ll track that as well.</span>
<span class="n">num_cpus</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-catalogs-and-downselect-ztf-to-nrows">
<h2>2. Read in catalogs and downselect ZTF to Nrows<a class="headerlink" href="#read-in-catalogs-and-downselect-ztf-to-nrows" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define sky area. Here we&#39;re using the Kepler field.</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;19:22:40  +44:30:00&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
<span class="n">cone_ra</span><span class="p">,</span> <span class="n">cone_dec</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span>

<span class="k">if</span> <span class="n">Nrows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">radius_arcsec</span> <span class="o">=</span> <span class="n">radius</span><span class="p">[</span><span class="n">Nrows</span><span class="p">]</span>
    <span class="n">search_filter</span> <span class="o">=</span> <span class="n">ConeSearch</span><span class="p">(</span><span class="n">cone_ra</span><span class="p">,</span> <span class="n">cone_dec</span><span class="p">,</span> <span class="n">radius_arcsec</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Full cross-match</span>
    <span class="c1"># ONLY ON XLARGE ENVIRONMENT USING AT LEAST 32 CPUS</span>
    <span class="n">search_filter</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Read ZTF DR23</span>
<span class="n">ztf_path</span> <span class="o">=</span> <span class="s2">&quot;s3://ipac-irsa-ztf/contributed/dr23/objects/hats&quot;</span>
<span class="n">ztf_piece</span> <span class="o">=</span> <span class="n">lsdb</span><span class="o">.</span><span class="n">open_catalog</span><span class="p">(</span>
    <span class="n">ztf_path</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;oid&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">],</span>
    <span class="n">search_filter</span><span class="o">=</span><span class="n">search_filter</span>
<span class="p">)</span>

<span class="c1"># Read Pan-STARRS DR2</span>
<span class="n">ps1_path</span> <span class="o">=</span> <span class="s2">&quot;s3://stpubdata/panstarrs/ps1/public/hats/otmo&quot;</span>
<span class="n">ps1_margin</span> <span class="o">=</span> <span class="s2">&quot;s3://stpubdata/panstarrs/ps1/public/hats/otmo_10arcs&quot;</span>
<span class="n">ps1</span> <span class="o">=</span> <span class="n">lsdb</span><span class="o">.</span><span class="n">open_catalog</span><span class="p">(</span>
    <span class="n">ps1_path</span><span class="p">,</span>
    <span class="n">margin_cache</span><span class="o">=</span><span class="n">ps1_margin</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;objName&quot;</span><span class="p">,</span><span class="s2">&quot;objID&quot;</span><span class="p">,</span><span class="s2">&quot;raMean&quot;</span><span class="p">,</span><span class="s2">&quot;decMean&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="initialize-the-crossmatch-and-compute-measuring-the-time-elapsed">
<h2>3. Initialize the crossmatch and compute, measuring the time elapsed.<a class="headerlink" href="#initialize-the-crossmatch-and-compute-measuring-the-time-elapsed" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setting up the cross-match actually takes very little time</span>
<span class="n">ztf_x_ps1</span> <span class="o">=</span> <span class="n">ztf_piece</span><span class="o">.</span><span class="n">crossmatch</span><span class="p">(</span><span class="n">ps1</span><span class="p">,</span> <span class="n">radius_arcsec</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_ztf&quot;</span><span class="p">,</span> <span class="s2">&quot;_ps1&quot;</span><span class="p">))</span>
<span class="n">ztf_x_ps1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><strong>lsdb Catalog ZTF_DR23_Objects_x_otmo:</strong></div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>oid_ztf</th>
      <th>ra_ztf</th>
      <th>dec_ztf</th>
      <th>objName_ps1</th>
      <th>objID_ps1</th>
      <th>raMean_ps1</th>
      <th>decMean_ps1</th>
      <th>_dist_arcsec</th>
    </tr>
    <tr>
      <th>npartitions=16</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Order: 6, Pixel: 15104</th>
      <td>int64[pyarrow]</td>
      <td>double[pyarrow]</td>
      <td>double[pyarrow]</td>
      <td>string[pyarrow]</td>
      <td>int64[pyarrow]</td>
      <td>double[pyarrow]</td>
      <td>double[pyarrow]</td>
      <td>double[pyarrow]</td>
    </tr>
    <tr>
      <th>Order: 6, Pixel: 15105</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Order: 6, Pixel: 15118</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Order: 6, Pixel: 15119</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
  </tbody>
</table>
</div><div>8 out of 8 available columns in the catalog have been loaded <strong>lazily</strong>, meaning no data has been read, only the catalog schema</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Executing the cross-match does take time</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">xmatch</span> <span class="o">=</span> <span class="n">ztf_x_ps1</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Elapsed:&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time Elapsed: 0:00:10.642885
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the length of the resulting table</span>
<span class="n">rows_out</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xmatch</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of rows out: </span><span class="si">{</span><span class="n">rows_out</span><span class="si">:</span><span class="s2">,d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of rows out: 8,593
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Close the Dask cluster/client when finished</span>
<span class="k">if</span> <span class="n">dask_workers</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">dask_workers</span> <span class="o">==</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span>
        <span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="record-and-plot-benchmarks">
<h2>4. Record and plot benchmarks<a class="headerlink" href="#record-and-plot-benchmarks" title="Link to this heading">#</a></h2>
<p>Write the recorded benchmark to an output file, then make plots to analyze the benchmarks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="c1"># read in file if it exists</span>
    <span class="n">benchmarks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;output/xmatch_benchmarks.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Ncpus&quot;</span><span class="p">,</span> <span class="s2">&quot;Nrows&quot;</span><span class="p">,</span> <span class="s2">&quot;Nworkers&quot;</span><span class="p">])</span>
<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
    <span class="c1"># otherwise create an empty DataFrame</span>
    <span class="n">multi_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="p">[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="n">codes</span><span class="o">=</span><span class="p">[[],</span> <span class="p">[],</span> <span class="p">[]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Ncpus&quot;</span><span class="p">,</span> <span class="s2">&quot;Nrows&quot;</span><span class="p">,</span> <span class="s2">&quot;Nworkers&quot;</span><span class="p">])</span>
    <span class="n">benchmarks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">multi_index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;Nrows_out&quot;</span><span class="p">,</span> <span class="s2">&quot;updated&quot;</span><span class="p">])</span>

<span class="c1"># assign values</span>
<span class="n">benchmarks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="p">(</span><span class="n">num_cpus</span><span class="p">,</span> <span class="n">Nrows</span><span class="p">,</span> <span class="n">dask_workers</span><span class="p">),</span>
    <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;Nrows_out&quot;</span><span class="p">,</span> <span class="s2">&quot;updated&quot;</span><span class="p">]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">rows_out</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

<span class="n">benchmarks</span> <span class="o">=</span> <span class="n">benchmarks</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="c1"># benchmarks.to_csv(&quot;output/xmatch_benchmarks.csv&quot;) # Uncomment this to write the new benchmarks to file</span>
<span class="n">benchmarks</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>time</th>
      <th>Nrows_out</th>
      <th>updated</th>
    </tr>
    <tr>
      <th>Ncpus</th>
      <th>Nrows</th>
      <th>Nworkers</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">2</th>
      <th rowspan="2" valign="top">10000</th>
      <th>1</th>
      <td>48.879788</td>
      <td>8593.0</td>
      <td>2025-08-05 18:13:57</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30.538154</td>
      <td>8593.0</td>
      <td>2025-08-05 18:15:26</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">128</th>
      <th>1000000000</th>
      <th>default</th>
      <td>1611.382256</td>
      <td>874362668.0</td>
      <td>2025-08-11 22:16:12</td>
    </tr>
    <tr>
      <th>7500000000</th>
      <th>default</th>
      <td>14539.090000</td>
      <td>NaN</td>
      <td>2025-08-12 21:37:39</td>
    </tr>
  </tbody>
</table>
<p>125 rows × 3 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">benchmarks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;output/xmatch_benchmarks.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Ncpus&quot;</span><span class="p">,</span> <span class="s2">&quot;Nrows&quot;</span><span class="p">,</span> <span class="s2">&quot;Nworkers&quot;</span><span class="p">])</span>

<span class="n">nworkers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_by_nworkers</span><span class="p">(</span><span class="n">num_cpus</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="c1"># Plot execution time vs. number of dask workers for each scale job</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">benchmarks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">num_cpus</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get the relevant benchmarks</span>
            <span class="n">b_N</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;Nrows&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># convert Nworkers to categorical with desired order</span>
        <span class="n">b_N</span><span class="p">[</span><span class="s2">&quot;Nworkers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">b_N</span><span class="p">[</span><span class="s2">&quot;Nworkers&quot;</span><span class="p">],</span>
                                            <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nworkers</span><span class="p">],</span>
                                            <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">b_N</span> <span class="o">=</span> <span class="n">b_N</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Nworkers&quot;</span><span class="p">)</span>

        <span class="c1"># only plot if there is more than 1 data point</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_N</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s2">&quot;Nworkers&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">b_N</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Nworkers&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Execution Time (s)&quot;</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_cpus</span><span class="si">}</span><span class="s2"> CPUs&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">cpu_counts</span> <span class="o">=</span> <span class="n">benchmarks</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;Ncpus&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ncpu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cpu_counts</span><span class="p">):</span>
    <span class="n">plot_by_nworkers</span><span class="p">(</span><span class="n">ncpu</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3d552baa2e288c2141d90de639763d7248bbb312c3b1016903828e97617de0d4.png" src="../_images/3d552baa2e288c2141d90de639763d7248bbb312c3b1016903828e97617de0d4.png" />
</div>
</div>
<p>These plots show how the cross-match execution time depends on the number of workers used. Broadly, increasing the number of workers up to the number of available CPUs improves the performance. The exception is for smaller cross-matches ($\le$ 1 million rows) spread across many ($\ge$ 16) CPUs, when the overhead of managing many workers is significant compared to the cross-match time. Increasing the number of workers past the number of CPUs results in somewhat worse performance. Interestingly, the agnostic approach—not manually specifying any <code class="docutils literal notranslate"><span class="pre">dask</span></code> parameters, but instead letting <code class="docutils literal notranslate"><span class="pre">lsdb</span></code> use the default <code class="docutils literal notranslate"><span class="pre">dask</span></code> behavior—results in the best performance for smaller cross-matches. This indicates that the <code class="docutils literal notranslate"><span class="pre">lsdb</span></code> cross-match functions are well-optimized and well-configured for use with <code class="docutils literal notranslate"><span class="pre">dask</span></code> without much user oversight, at least on cross-matches with $\le$ 1 million rows.</p>
<p>For the largest jobs (<code class="docutils literal notranslate"><span class="pre">Nrows</span></code> $\ge$ 10 million), the default <code class="docutils literal notranslate"><span class="pre">dask</span></code> configuration performs worse than fixing the number of <code class="docutils literal notranslate"><span class="pre">dask_workers</span></code> to be the number of available CPUs. Interestingly, on the XLarge server with 128 CPUs, the 64-worker run performed the best on the large cross-matches. For larger cross-matches, we recommend manually setting the number of workers to be $\frac{1}{2} N_\mathrm{CPU} \leq N_\mathrm{workers} \leq N_\mathrm{CPU}$.</p>
<p>Given the amount of time it takes to perform the largest cross-matches (<code class="docutils literal notranslate"><span class="pre">Nrows</span></code> $\ge$ 1 billion), these were run only on the XLarge server using the default <code class="docutils literal notranslate"><span class="pre">dask</span></code> configuration. The full cross-match of over 7 billion rows took just over 4 hours.</p>
<p>These graphs also illustrate the approximate maximum number of rows that can be cross matched with a given amount of RAM and CPU. Trying to cross-match more rows or use worker configurations that aren’t shown in the plots can lead to one of the following behaviors:</p>
<p><strong>Small (4GB RAM, 2 CPU)</strong></p>
<p>When attempting <code class="docutils literal notranslate"><span class="pre">Nrows</span></code> $\ge$ 10 million, the cross-match exhibits long compute times, seeming never to finish.</p>
<p><strong>Medium (16GB RAM, 4 CPU)</strong></p>
<p>When attempting <code class="docutils literal notranslate"><span class="pre">Nrows</span></code> $\ge$ 100 million, the cross-match exhibits long compute times, seeming never to finish.</p>
<p><strong>Large (64GB RAM, 16 CPU)</strong></p>
<p>When attempting <code class="docutils literal notranslate"><span class="pre">Nrows</span></code> = 100 million with anything but 16 or ‘default’ values for <code class="docutils literal notranslate"><span class="pre">dask_workers</span></code>, the cross-match exhibits long compute times, seeming never to finish. When attempting <code class="docutils literal notranslate"><span class="pre">Nrows</span></code> $\ge$ 1 billion, the cross-match exhibits long compute times, seeming never to finish.</p>
<p><strong>XLarge (512GB RAM, 128 CPU)</strong></p>
<p>The XLarge environment was able to complete all attempted cross-matches, except that setting <code class="docutils literal notranslate"><span class="pre">dask_workers='scale'</span></code> resulted in the dead worker behavior documented below.</p>
<p><strong>Autoscaling on any environment</strong></p>
<p>When using <code class="docutils literal notranslate"><span class="pre">dask_workers='scale'</span></code> and scaling up the number of rows to cross-match, eventually you will see logging output from the <code class="docutils literal notranslate"><span class="pre">dask</span></code> cluster indicating that workers have died and are being respawn. This behavior repeats, and the cross-match never finishes (after being allowed to run for, e.g., an hour when it is expected to finish in 5 minutes).</p>
</section>
<section id="summary">
<h2>5. Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>The Fornax Science Console is capable of hosting cross-matches between large catalogs using the <code class="docutils literal notranslate"><span class="pre">lsdb</span></code> package. <code class="docutils literal notranslate"><span class="pre">lsdb</span></code> leverages <code class="docutils literal notranslate"><span class="pre">dask</span></code> to efficiently plan cross-match jobs using multiple workers, which results in large performance gains, especially as jobs scale up to millions or tens of millions of catalog rows.</p>
<p><strong>Recommendations</strong></p>
<ul class="simple">
<li><p>For small cross-matches (1 million rows or less) it is acceptable and often optimal to use <code class="docutils literal notranslate"><span class="pre">lsdb</span></code>’s default <code class="docutils literal notranslate"><span class="pre">dask</span></code> settings to parallelize jobs. In other words, for these jobs you don’t need to configure or even import <code class="docutils literal notranslate"><span class="pre">dask</span></code> at all to leverage its parallelization power.</p></li>
<li><p>For large cross-matches (millions of rows or more), we recommend running in an environment with at least tens of CPUs, and setting the number of <code class="docutils literal notranslate"><span class="pre">dask</span></code> workers to at least half the number of available CPUs, and up to the number of CPUs. E.g., 128 CPUs with 64 <code class="docutils literal notranslate"><span class="pre">dask</span></code> workers.</p></li>
<li><p>Cross-matches of 10 million rows or less can, at the time of writing, be completed on the Small Fornax Console using the default <code class="docutils literal notranslate"><span class="pre">dask</span></code> configuration. However, given the performance, we recommend the following use scaling:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Nrows</span></code> $\le 10^6$: Small</p></li>
<li><p>$10^6 &lt;$ <code class="docutils literal notranslate"><span class="pre">Nrows</span></code> $&lt; 10^7$: Medium</p></li>
<li><p>$10^7 &lt;$ <code class="docutils literal notranslate"><span class="pre">Nrows</span></code> $&lt; 10^8$: Large</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Nrows</span></code> $&gt; 10^8$: XLarge</p></li>
</ul>
</li>
</ul>
<p>In this tutorial we have cross-matched sections of catalogs in a particular region of sky, where most of the stars likely fall in the same or neighboring sky cells. It would be useful in the future to try this using generic samples of stars from across the entire sky. How different is performance when the catalog rows come from many sky cells instead of just a few? We have also generated the cross-match using <code class="docutils literal notranslate"><span class="pre">compute</span></code>, which loads the full result into memory, but <code class="docutils literal notranslate"><span class="pre">lsdb</span></code> supports larger-than-memory cross-matches by writing them directly to disk using <code class="docutils literal notranslate"><span class="pre">to_hats</span></code>. It would also be illustrative to run these benchmarks, and benchmarking a full cross-match between ZTF and Pan-STARRS, by writing the result to disk.</p>
<p><strong>Other Science Cases</strong></p>
<p>The example science case used here is an investigation to collect time-series photometry from sources in and around the Kepler field. The time series associated with the ZTF and Pan-STARRS sources might be used to supplement the Kepler light curves, extend their time baseline, examine how stellar light curves change in different photometric filters, and more. But <code class="docutils literal notranslate"><span class="pre">lsdb</span></code> enables other science cases with other catalogs as well. Some examples might be to</p>
<ul class="simple">
<li><p>combine photometric spectral energy distributions (SEDs) of distant galaxies with their spectra to build a training set for machine learning to predict photometric redshifts,</p></li>
<li><p>combine Gaia’s exquisite astrometry with your favorite star survey to obtain 6D kinematic solutions for your sample stars,</p></li>
<li><p>combine stellar spectroscopic catalogs with light curve rotation period measurements to estimate stellar ages using gyrochronology.</p></li>
</ul>
</section>
<section id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Authors:</strong> Zach Claytor (Astronomical Data Scientist at Space Telescope Science Institute) and the Fornax team</p></li>
<li><p><strong>Contact:</strong> For help with this notebook, please open a topic in the <a class="reference external" href="https://discourse.fornax.sciencecloud.nasa.gov/">Fornax Community Forum</a> “Support” category.</p></li>
</ul>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>This work uses <a class="reference external" href="https://www.astropy.org/acknowledging.html"><code class="docutils literal notranslate"><span class="pre">astropy</span></code></a>.</p></li>
<li><p>This work uses <a class="reference external" href="https://docs.lsdb.io/"><code class="docutils literal notranslate"><span class="pre">lsdb</span></code></a>.</p></li>
</ul>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="README.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Cross Matching</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#runtime">Runtime</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preconfiguring-the-run">1. Preconfiguring the Run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-catalogs-and-downselect-ztf-to-nrows">2. Read in catalogs and downselect ZTF to Nrows</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialize-the-crossmatch-and-compute-measuring-the-time-elapsed">3. Initialize the crossmatch and compute, measuring the time elapsed.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#record-and-plot-benchmarks">4. Record and plot benchmarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">5. Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this Notebook</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Fornax developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2025, Fornax developers.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>