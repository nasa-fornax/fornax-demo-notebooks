
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Automated Multiband Forced Photometry on Large Datasets &#8212; Fornax Demo Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'forced_photometry/multiband_photometry';</script>
    <link rel="icon" href="../_static/fornax_favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Time Domain" href="../light_curves/README.html" />
    <link rel="prev" title="Multi-band forced photometry" href="README.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/fornax_logo.png" class="logo__image only-light" alt="Fornax Demo Notebooks - Home"/>
    <script>document.write(`<img src="../_static/fornax_logo.png" class="logo__image only-dark" alt="Fornax Demo Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/nasa-fornax/fornax-demo-notebooks" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    The Fornax Initiative
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorial Notebooks</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="README.html">Multi-band forced photometry</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Automated Multiband Forced Photometry on Large Datasets</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../light_curves/README.html">Time Domain</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../light_curves/light_curve_generator.html">Make Multi-Wavelength Light Curves Using Archival Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../light_curves/scale_up.html">Make Multi-Wavelength Light Curves for Large Samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../light_curves/light_curve_classifier.html">Light Curve Classifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../light_curves/ML_AGNzoo.html">AGN Zoo: Comparison of AGN selected with different metrics</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">User Documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../documentation/README.html">Fornax Science Console</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/nasa-fornax/fornax-demo-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/nasa-fornax/fornax-demo-notebooks/edit/main/forced_photometry/multiband_photometry.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/nasa-fornax/fornax-demo-notebooks/issues/new?title=Issue%20on%20page%20%2Fforced_photometry/multiband_photometry.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/forced_photometry/multiband_photometry.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Automated Multiband Forced Photometry on Large Datasets</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input">Input:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#output">Output:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">Authors:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-standard-dependencies">Non-standard Dependencies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieve-initial-catalog-from-irsa">1. Retrieve Initial Catalog from IRSA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-filter-catalog">1a. Filter Catalog</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieve-image-datasets-from-the-cloud">2. Retrieve Image Datasets from the Cloud</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-fornax-cloud-access-api-to-obtain-the-irac-data-from-the-irsa-s3-bucket">Use the fornax cloud access API to obtain the IRAC data from the IRSA S3 bucket.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-ivoa-image-search-and-fornax-download-to-obtain-galex-from-the-mast-archive">Use IVOA image search and Fornax download to obtain Galex from the MAST archive</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-forced-photometry">3.  Run Forced Photometry</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-setup">3a. Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-main-function-to-do-the-forced-photometry">3b. Main Function to do the Forced Photometry</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-calculate-forced-photometry-with-straightforward-but-slow-method">3c. Calculate Forced Photometry with Straightforward but Slow Method</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-calculate-forced-photometry-parallelization">3d. Calculate Forced Photometry - Parallelization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#e-cleanup">3e. Cleanup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f-plot-to-confirm-our-photometry-results">3f. Plot to Confirm our Photometry Results</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-match-our-new-photometry-catalog-with-an-x-ray-archival-catalog">4. Cross Match our New Photometry Catalog with an X-ray archival Catalog</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-retrieve-the-heasarc-catalog">4a. Retrieve the HEASARC Catalog</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-run-nway-to-do-the-cross-match">4b. Run <code class="docutils literal notranslate"><span class="pre">nway</span></code> to do the Cross-Match</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-final-results">5. Plot Final Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="automated-multiband-forced-photometry-on-large-datasets">
<h1>Automated Multiband Forced Photometry on Large Datasets<a class="headerlink" href="#automated-multiband-forced-photometry-on-large-datasets" title="Link to this heading">#</a></h1>
<section id="learning-goals">
<h2>Learning Goals:<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h2>
<p>By the end of this tutorial, you will be able to:</p>
<ul class="simple">
<li><p>get catalogs and images from NASA archives in the cloud where possible</p></li>
<li><p>measure fluxes at any location by running forced photometry using “The Tractor”</p></li>
<li><p>employ parallel processing to make this as fast as possible</p></li>
<li><p>cross match large catalogs</p></li>
<li><p>plot results</p></li>
</ul>
</section>
<section id="introduction">
<h2>Introduction:<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>This code performs photometry in an automated fashion at all locations in an input catalog on 4 bands of IRAC data from IRSA and 2 bands of Galex data from MAST.  The resulting catalog is then cross-matched with a Chandra catalog from HEASARC to generate a multiband catalog to facilitate galaxy evolution studies.</p>
<p>The code will run on 2 different science platforms and makes full use of multiple processors to optimize run time on large datasets.</p>
</section>
<section id="input">
<h2>Input:<a class="headerlink" href="#input" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>RA and DEC within COSMOS catalog</p></li>
<li><p>desired catalog radius in arcminutes</p></li>
<li><p>mosaics of that region for IRAC and Galex</p></li>
</ul>
</section>
<section id="output">
<h2>Output:<a class="headerlink" href="#output" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>merged, multiband, science ready pandas dataframe</p></li>
<li><p>IRAC color color plot for identifying interesting populations</p></li>
</ul>
</section>
<section id="authors">
<h2>Authors:<a class="headerlink" href="#authors" title="Link to this heading">#</a></h2>
<p>Jessica Krick, David Shupe, Marziye JafariYazani, Brigitta Sipőcz, Vandana Desai, Steve Groom, Troy Raen</p>
</section>
<section id="acknowledgements">
<h2>Acknowledgements:<a class="headerlink" href="#acknowledgements" title="Link to this heading">#</a></h2>
<p>Kristina Nyland for the workflow of the tractor wrapper.<br />
MAST, HEASARC, &amp; IRSA Fornax teams</p>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h2>
</section>
<section id="non-standard-dependencies">
<h2>Non-standard Dependencies<a class="headerlink" href="#non-standard-dependencies" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tractor</span></code> code which does the forced photometry from Lang et al., 2016</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astroquery</span></code> to interface with archives APIs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy</span></code> to work with coordinates/units and data structures</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">skimage</span></code> to work with the images</p></li>
</ul>
<p>This cell will install the Python ones if needed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment the next line to install dependencies if needed.</span>
<span class="c1"># !pip install -r requirements_multiband_photometry.txt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># standard lib imports</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>

<span class="c1"># Third party imports</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">rotate</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">statsmodels</span>
<span class="kn">import</span> <span class="nn">mpld3</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">Cutout2D</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>

<span class="kn">from</span> <span class="nn">astroquery.ipac.irsa</span> <span class="kn">import</span> <span class="n">Irsa</span>
<span class="kn">from</span> <span class="nn">astroquery.heasarc</span> <span class="kn">import</span> <span class="n">Heasarc</span>
<span class="kn">from</span> <span class="nn">astroquery.mast</span> <span class="kn">import</span> <span class="n">Observations</span>
<span class="kn">import</span> <span class="nn">pyvo</span>

<span class="c1"># Local code imports</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;code_src/&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">display_images</span> <span class="kn">import</span> <span class="n">display_images</span>
<span class="kn">import</span> <span class="nn">cutout</span>
<span class="kn">from</span> <span class="nn">exceptions</span> <span class="kn">import</span> <span class="n">TractorError</span>
<span class="kn">import</span> <span class="nn">photometry</span>
<span class="kn">from</span> <span class="nn">plot_SED</span> <span class="kn">import</span> <span class="n">plot_SED</span>
<span class="kn">from</span> <span class="nn">nway_write_header</span> <span class="kn">import</span> <span class="n">nway_write_header</span>
<span class="kn">from</span> <span class="nn">photometry</span> <span class="kn">import</span> <span class="n">Band</span>
<span class="kn">from</span> <span class="nn">photometry</span> <span class="kn">import</span> <span class="n">lookup_img_pair</span>
<span class="c1">#from prepare_prf import prepare_prf</span>

<span class="c1"># temporarily let the notebook start without tractor as dependency</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">find_nconfsources</span> <span class="kn">import</span> <span class="n">find_nconfsources</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tractor is missing&quot;</span><span class="p">)</span>
    <span class="k">pass</span>

<span class="c1"># Add ~/.local/bin to path so executables installed with pip are available (needed for nway)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/.local/bin:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="retrieve-initial-catalog-from-irsa">
<h2>1. Retrieve Initial Catalog from IRSA<a class="headerlink" href="#retrieve-initial-catalog-from-irsa" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Automatically set up a catalog with ra, dec, photometric redshifts, fiducial band fluxes, &amp; probability that it is a star</p></li>
<li><p>Catalog we are using is COSMOS2015 (Laigle et al. 2016)</p></li>
<li><p>Data exploration</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#pull a COSMOS catalog from IRSA using pyVO</span>

<span class="c1">#what is the central RA and DEC of the desired catalog</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;150.01d 2.2d&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>  <span class="c1">#COSMOS center acording to Simbad</span>

<span class="c1">#how large is the search radius, in arcmin</span>
<span class="c1"># full area of COSMOS is radius = 48&#39;</span>
<span class="c1"># running this code on the full COSMOS area takes ~24 hours on a 128core server, therefore</span>
<span class="c1"># start with a manageable radius and increase as needed</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span>


<span class="c1">#specify only select columns to limit the size of the catalog</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks_FLUX_APER2&#39;</span><span class="p">,</span> <span class="s1">&#39;Ks_FLUXERR_APER2&#39;</span><span class="p">,</span> <span class="s1">&#39;PHOTOZ&#39;</span><span class="p">,</span> <span class="s1">&#39;SPLASH_1_MAG&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SPLASH_1_MAGERR&#39;</span><span class="p">,</span> <span class="s1">&#39;SPLASH_1_FLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;SPLASH_1_FLUX_ERR&#39;</span><span class="p">,</span> <span class="s1">&#39;SPLASH_2_FLUX&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SPLASH_2_FLUX_ERR&#39;</span><span class="p">,</span> <span class="s1">&#39;SPLASH_3_FLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;SPLASH_3_FLUX_ERR&#39;</span><span class="p">,</span> <span class="s1">&#39;SPLASH_4_FLUX&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SPLASH_4_FLUX_ERR&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX_GALEX_NUV&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX_GALEX_FUV&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX_CHANDRA_05_2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FLUX_CHANDRA_2_10&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX_CHANDRA_05_10&#39;</span><span class="p">,</span> <span class="s1">&#39;ID_CHANDRA09 &#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;r_MAG_AUTO&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r_MAGERR_AUTO&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX_24&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUXERR_24&#39;</span><span class="p">,</span> <span class="s1">&#39;MAG_GALEX_NUV&#39;</span><span class="p">,</span> <span class="s1">&#39;MAGERR_GALEX_NUV&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MAG_GALEX_FUV&#39;</span><span class="p">,</span> <span class="s1">&#39;MAGERR_GALEX_FUV&#39;</span>
<span class="p">]</span>

<span class="n">tap</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">TAPService</span><span class="p">(</span><span class="s1">&#39;https://irsa.ipac.caltech.edu/TAP&#39;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tap</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">           SELECT </span><span class="si">{}</span>
<span class="s2">           FROM cosmos2015</span>
<span class="s2">           WHERE CONTAINS(POINT(&#39;ICRS&#39;,ra, dec), CIRCLE(&#39;ICRS&#39;,</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">))=1</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">coords</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">radius</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
<span class="n">cosmos_table</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of objects: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cosmos_table</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<section id="a-filter-catalog">
<h3>1a. Filter Catalog<a class="headerlink" href="#a-filter-catalog" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>if desired could filter the initial catalog to only include desired sources</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#an example of how to filter the catalog to</span>
<span class="c1">#select those rows with either chandra fluxes or Galex NUV fluxes</span>

<span class="c1">#example_table = cosmos_table[(cosmos_table[&#39;flux_chandra_05_10&#39;]&gt; 0) | (cosmos_table[&#39;flux_galex_fuv&#39;] &gt; 0)]</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="retrieve-image-datasets-from-the-cloud">
<h2>2. Retrieve Image Datasets from the Cloud<a class="headerlink" href="#retrieve-image-datasets-from-the-cloud" title="Link to this heading">#</a></h2>
<section id="use-the-fornax-cloud-access-api-to-obtain-the-irac-data-from-the-irsa-s3-bucket">
<h3>Use the fornax cloud access API to obtain the IRAC data from the IRSA S3 bucket.<a class="headerlink" href="#use-the-fornax-cloud-access-api-to-obtain-the-irac-data-from-the-irsa-s3-bucket" title="Link to this heading">#</a></h3>
<p>Details here may change as the prototype code is being added to the appropriate libraries, as well as the data holding to the appropriate NGAP storage as opposed to IRSA resources.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Temporary solution, remove when the fornax API is added to the image</span>
<span class="c1"># This relies on the assumption that https://github.com/nasa-fornax/fornax-cloud-access-API is being cloned to this environment.</span>
<span class="c1"># If it&#39;s not, then run a ``git clone https://github.com/nasa-fornax/fornax-cloud-access-API --depth=1`` from a terminal at the highest directory root.</span>
<span class="c1"># You may need to update the fork if you forked it in the past</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;../../fornax-cloud-access-API&#39;</span><span class="p">):</span>
    <span class="err">!</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">nasa</span><span class="o">-</span><span class="n">fornax</span><span class="o">/</span><span class="n">fornax</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">access</span><span class="o">-</span><span class="n">API</span> <span class="o">--</span><span class="n">depth</span><span class="o">=</span><span class="mi">1</span> <span class="o">../../</span><span class="n">fornax</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">access</span><span class="o">-</span><span class="n">API</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../fornax-cloud-access-API&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">pyvo</span>
<span class="kn">import</span> <span class="nn">fornax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Getting the COSMOS address from the registry to follow PyVO user case approach. We could hardwire it.</span>
<span class="n">image_services</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">regsearch</span><span class="p">(</span><span class="n">servicetype</span><span class="o">=</span><span class="s1">&#39;sia&#39;</span><span class="p">)</span>
<span class="n">irsa_cosmos</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">image_services</span> <span class="k">if</span> <span class="s1">&#39;irsa&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">ivoid</span> <span class="ow">and</span> <span class="s1">&#39;cosmos&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">ivoid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># The search returns 11191 entries, but unfortunately we cannot really filter efficiently in the query</span>
<span class="c1"># itself (https://irsa.ipac.caltech.edu/applications/Atlas/AtlasProgramInterface.html#inputparam)</span>
<span class="c1"># to get only the Spitzer IRAC results from COSMOS as a mission. We will do the filtering in a next step before download.</span>
<span class="n">cosmos_results</span> <span class="o">=</span> <span class="n">irsa_cosmos</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>

<span class="n">spitzer</span> <span class="o">=</span> <span class="n">cosmos_results</span><span class="p">[</span><span class="n">cosmos_results</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IRAC&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Temporarily add the cloud_access metadata to the Atlas response.</span>
<span class="c1"># This dataset has limited acces, thus &#39;region&#39; should be used instead of &#39;open&#39;.</span>
<span class="c1"># S3 access should be available from the daskhub and those who has their IRSA token set up.</span>

<span class="n">fname</span> <span class="o">=</span> <span class="n">spitzer</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
<span class="n">spitzer</span><span class="p">[</span><span class="s1">&#39;cloud_access&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">&quot;aws&quot;: </span><span class="se">{{</span><span class="s1"> &quot;bucket_name&quot;: &quot;irsa-mast-tike-spitzer-data&quot;,&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;              &quot;region&quot;: &quot;us-east-1&quot;,&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;              &quot;access&quot;: &quot;restricted&quot;,&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;              &quot;key&quot;: &quot;data/COSMOS/</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">&quot; </span><span class="se">}}</span><span class="s1"> </span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adding function to download multiple files using the fornax API.</span>
<span class="c1"># Requires https://github.com/nasa-fornax/fornax-cloud-access-API/pull/4</span>
<span class="k">def</span> <span class="nf">fornax_download</span><span class="p">(</span><span class="n">data_table</span><span class="p">,</span> <span class="n">data_subdirectory</span><span class="p">,</span> <span class="n">access_url_column</span><span class="o">=</span><span class="s1">&#39;access_url&#39;</span><span class="p">,</span>
                    <span class="n">fname_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">working_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="n">data_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">data_subdirectory</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_directory</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_table</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fname_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fname_filter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">fornax</span><span class="o">.</span><span class="n">get_data_product</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="n">access_url_column</span><span class="o">=</span><span class="n">access_url_column</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">temp_file</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
        <span class="c1"># on-prem download returns temp file path, s3 download downloads file</span>
        <span class="k">if</span> <span class="n">temp_file</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]))</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fornax_download</span><span class="p">(</span><span class="n">spitzer</span><span class="p">,</span> <span class="n">access_url_column</span><span class="o">=</span><span class="s1">&#39;sia_url&#39;</span><span class="p">,</span> <span class="n">fname_filter</span><span class="o">=</span><span class="s1">&#39;go2_sci&#39;</span><span class="p">,</span>
                <span class="n">data_subdirectory</span><span class="o">=</span><span class="s1">&#39;IRAC&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-ivoa-image-search-and-fornax-download-to-obtain-galex-from-the-mast-archive">
<h3>Use IVOA image search and Fornax download to obtain Galex from the MAST archive<a class="headerlink" href="#use-ivoa-image-search-and-fornax-download-to-obtain-galex-from-the-mast-archive" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#the Galex mosaic of COSMOS is broken into 4 seperate images</span>
<span class="c1">#need to know which Galex image the targets are nearest to.</span>
<span class="c1">#make a new column in dataframe which figures this out</span>

<span class="c1">#four centers for 1, 2, 3, 4 are</span>
<span class="n">ra_center</span><span class="o">=</span><span class="p">[</span><span class="mf">150.369</span><span class="p">,</span><span class="mf">150.369</span><span class="p">,</span><span class="mf">149.869</span><span class="p">,</span><span class="mf">149.869</span><span class="p">]</span>
<span class="n">dec_center</span><span class="o">=</span><span class="p">[</span><span class="mf">2.45583</span><span class="p">,</span><span class="mf">1.95583</span><span class="p">,</span><span class="mf">2.45583</span><span class="p">,</span><span class="mf">1.95583</span><span class="p">]</span>

<span class="n">galex</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span> <span class="o">=</span> <span class="n">ra_center</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">dec_center</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span> <span class="o">=</span> <span class="n">cosmos_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">cosmos_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">])</span>
<span class="c1">#idx, d2d, d3d = match_coordinates_sky(galex, catalog)  #only finds the nearest one</span>
<span class="c1">#idx, d2d, d3d = galex.match_to_catalog_sky(catalog)  #only finds the nearest one</span>

<span class="n">cosmos_table</span><span class="p">[</span><span class="s1">&#39;COSMOS_01&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>
<span class="n">cosmos_table</span><span class="p">[</span><span class="s1">&#39;COSMOS_02&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>
<span class="n">cosmos_table</span><span class="p">[</span><span class="s1">&#39;COSMOS_03&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galex</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>
<span class="n">cosmos_table</span><span class="p">[</span><span class="s1">&#39;COSMOS_04&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">galex</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>

<span class="c1">#convert to pandas</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">cosmos_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

<span class="c1">#which row has the minimum value of distance to the galex images</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;galex_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;COSMOS_01&#39;</span><span class="p">,</span><span class="s1">&#39;COSMOS_02&#39;</span><span class="p">,</span><span class="s1">&#39;COSMOS_03&#39;</span><span class="p">,</span><span class="s1">&#39;COSMOS_04&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 76k with 15arcmin diameter IRAC images</span>
<span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assign the endpoint for the MAST Galex Simple Image Access service.</span>
<span class="n">galex_sia_url</span> <span class="o">=</span> <span class="s1">&#39;https://mast.stsci.edu/portal_vo/Mashup/VoQuery.asmx/SiaV1?MISSION=GALEX&amp;&#39;</span>

<span class="c1"># Query the Galex SIA service using the COSMOS coordinates defined above.</span>
<span class="n">query_result</span> <span class="o">=</span> <span class="n">pyvo</span><span class="o">.</span><span class="n">dal</span><span class="o">.</span><span class="n">sia</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">galex_sia_url</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">galex_image_products</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>

<span class="c1"># Filter the products so we only download SCIENCE products with exposure time &gt; 40000</span>
<span class="n">filtered_products</span> <span class="o">=</span> <span class="n">galex_image_products</span><span class="p">[(</span><span class="n">galex_image_products</span><span class="p">[</span><span class="s1">&#39;timExposure&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">40000.0</span><span class="p">)]</span>
<span class="n">filtered_products</span> <span class="o">=</span> <span class="n">filtered_products</span><span class="p">[(</span><span class="n">filtered_products</span><span class="p">[</span><span class="s1">&#39;productType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SCIENCE&quot;</span><span class="p">)]</span>

<span class="c1"># The column containing the on-prem access to fall back on if cloud is unavailable</span>
<span class="n">access_url_column</span> <span class="o">=</span> <span class="n">query_result</span><span class="o">.</span><span class="n">fieldname_with_ucd</span><span class="p">(</span><span class="s1">&#39;VOX:Image_AccessReference&#39;</span><span class="p">)</span>

<span class="c1"># Download filtered products from AWS</span>
<span class="n">download_subdir</span> <span class="o">=</span> <span class="s1">&#39;Galex&#39;</span>
<span class="n">fornax_download</span><span class="p">(</span><span class="n">filtered_products</span><span class="p">,</span> <span class="n">access_url_column</span><span class="o">=</span><span class="n">access_url_column</span><span class="p">,</span> <span class="n">data_subdirectory</span><span class="o">=</span><span class="n">download_subdir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the GALEX sky background fits files in addition to the mosaics</span>
<span class="n">skybg_products</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">skybkg_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;COSMOS_0[1-4]-[fn]d-skybg&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">galex_image_products</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">skybkg_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
        <span class="n">skybg_products</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="c1"># Download skybg products from AWS</span>
<span class="n">download_subdir</span> <span class="o">=</span> <span class="s1">&#39;Galex&#39;</span>
<span class="n">fornax_download</span><span class="p">(</span><span class="n">skybg_products</span><span class="p">,</span> <span class="n">access_url_column</span><span class="o">=</span><span class="n">access_url_column</span><span class="p">,</span> <span class="n">data_subdirectory</span><span class="o">=</span><span class="n">download_subdir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#make sure there aren&#39;t any troublesome rows in the catalog</span>
<span class="c1">#are there missing values in any rows?</span>
<span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1">#don&#39;t mind that there are missing values for some of the fluxes</span>
<span class="c1">#The rest of the rows are complete</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#out of curiosity how many of each type of source are in this catalog</span>
<span class="c1">#Type: 0 = galaxy, 1 = star, 2 = X-ray source, -9 is failure to fit</span>
<span class="n">df</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="run-forced-photometry">
<h2>3.  Run Forced Photometry<a class="headerlink" href="#run-forced-photometry" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Calculate a flux at a given position in 2 IRAC and 2 Galex bands</p></li>
</ul>
<section id="a-setup">
<h3>3a. Setup<a class="headerlink" href="#a-setup" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>initialize data frame columns to hold the results</p></li>
<li><p>collect the parameters for each band/channel</p></li>
<li><p>collect the input images</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize columns in data frame for photometry results</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ch1flux&quot;</span><span class="p">,</span> <span class="s2">&quot;ch1flux_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;ch2flux&quot;</span><span class="p">,</span> <span class="s2">&quot;ch2flux_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;ch3flux&quot;</span><span class="p">,</span> <span class="s2">&quot;ch3flux_unc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ch4flux&quot;</span><span class="p">,</span> <span class="s2">&quot;ch4flux_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;ch5flux&quot;</span><span class="p">,</span> <span class="s2">&quot;ch5flux_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;ch6flux&quot;</span><span class="p">,</span> <span class="s2">&quot;ch6flux_unc&quot;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># list to collect all the bands</span>
<span class="n">all_bands</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># IRAC channels</span>

<span class="n">irac_band_indexes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span>  <span class="c1"># ch1</span>
    <span class="mi">1</span><span class="p">,</span>  <span class="c1"># ch2</span>
    <span class="mi">2</span><span class="p">,</span>  <span class="c1"># ch3</span>
    <span class="mi">3</span><span class="p">,</span>  <span class="c1"># ch4</span>
<span class="p">]</span>

<span class="n">irac_fluxconversion</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1E12</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.254517E10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">irac_mosaic_pix_scale</span> <span class="o">=</span> <span class="mf">0.6</span>

<span class="n">irac_cutout_width</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># in arcseconds, taken from Nyland et al. 2017</span>

<span class="n">irac_prfs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;data/IRAC/PRF_IRAC_ch1.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;data/IRAC/PRF_IRAC_ch2.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;data/IRAC/PRF_IRAC_ch3.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;data/IRAC/PRF_IRAC_ch4.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># zip parameters for each band into a container and append to the master list</span>
<span class="n">irac_bands</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Band</span><span class="p">(</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">prf</span><span class="p">,</span> <span class="n">irac_cutout_width</span><span class="p">,</span> <span class="n">irac_fluxconversion</span><span class="p">,</span> <span class="n">irac_mosaic_pix_scale</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">irac_band_indexes</span><span class="p">,</span> <span class="n">irac_prfs</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">all_bands</span> <span class="o">+=</span> <span class="n">irac_bands</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># GALEX bands</span>

<span class="n">galex_band_indexes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">4</span><span class="p">,</span>  <span class="c1"># nuv</span>
    <span class="mi">5</span><span class="p">,</span>  <span class="c1"># fuv</span>
<span class="p">]</span>

<span class="n">galex_cutout_width</span> <span class="o">=</span> <span class="mi">40</span>

<span class="n">galex_fluxconversions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">3.373E1</span><span class="p">,</span>  <span class="c1"># uJy. fudging this to make the numbers bigger for plotting later</span>
    <span class="mf">1.076E2</span><span class="p">,</span>  <span class="c1"># uJy. fudging this to make the numbers bigger for plotting later</span>
<span class="p">]</span>

<span class="n">galex_mosaic_pix_scale</span> <span class="o">=</span> <span class="mf">1.5</span>

<span class="n">prf_nuv</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;data/Galex/PSFnuv_faint.fits&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">prf_fuv</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;data/Galex/PSFfuv.fits&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">prf_nuv</span> <span class="o">=</span> <span class="n">prf_nuv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">119</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">119</span><span class="p">]</span>
<span class="n">prf_fuv</span> <span class="o">=</span> <span class="n">prf_fuv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">119</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">119</span><span class="p">]</span>

<span class="c1">#these are much larger than the cutouts we are using, so only keep the central region which is the size of our cutouts</span>
<span class="n">ngalex_pix</span> <span class="o">=</span> <span class="n">galex_cutout_width</span> <span class="o">/</span> <span class="n">galex_mosaic_pix_scale</span>
<span class="n">prf_cen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<span class="n">prf_nuv</span> <span class="o">=</span> <span class="n">prf_nuv</span><span class="p">[(</span><span class="n">prf_cen</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngalex_pix</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">prf_cen</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngalex_pix</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                  <span class="p">(</span><span class="n">prf_cen</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngalex_pix</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">prf_cen</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngalex_pix</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))]</span>
<span class="n">prf_fuv</span> <span class="o">=</span> <span class="n">prf_fuv</span><span class="p">[(</span><span class="n">prf_cen</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngalex_pix</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">prf_cen</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngalex_pix</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                  <span class="p">(</span><span class="n">prf_cen</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngalex_pix</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">prf_cen</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">ngalex_pix</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))]</span>
<span class="n">galex_prfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">prf_nuv</span><span class="p">,</span> <span class="n">prf_fuv</span><span class="p">]</span>

<span class="c1"># zip parameters for each band into a container and append to the master list</span>
<span class="n">galex_bands</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Band</span><span class="p">(</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">prf</span><span class="p">,</span> <span class="n">galex_cutout_width</span><span class="p">,</span> <span class="n">flux_conv</span><span class="p">,</span> <span class="n">galex_mosaic_pix_scale</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prf</span><span class="p">,</span> <span class="n">flux_conv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">galex_band_indexes</span><span class="p">,</span> <span class="n">galex_prfs</span><span class="p">,</span> <span class="n">galex_fluxconversions</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">all_bands</span> <span class="o">+=</span> <span class="n">galex_bands</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Collect input images</span>
<span class="c1"># collect the files in pairs: (science image, sky-background image)</span>
<span class="c1"># if the same file should be used for both, just send it once</span>
<span class="n">sci_bkg_pairs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># IRAC. use the science image to calculate the background</span>
    <span class="p">(</span><span class="s1">&#39;data/IRAC/irac_ch1_go2_sci_10.fits&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/IRAC/irac_ch2_go2_sci_10.fits&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/IRAC/irac_ch3_go2_sci_10.fits&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/IRAC/irac_ch4_go2_sci_10.fits&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="c1"># GALEX. calculate the background from a dedicated file</span>
    <span class="p">(</span><span class="s1">&#39;data/Galex/COSMOS_01-nd-int.fits.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;data/Galex/COSMOS_01-nd-skybg.fits.gz&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/Galex/COSMOS_01-fd-int.fits.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;data/Galex/COSMOS_01-fd-skybg.fits.gz&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/Galex/COSMOS_02-nd-int.fits.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;data/Galex/COSMOS_02-nd-skybg.fits.gz&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/Galex/COSMOS_02-fd-int.fits.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;data/Galex/COSMOS_02-fd-skybg.fits.gz&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/Galex/COSMOS_03-nd-int.fits.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;data/Galex/COSMOS_03-nd-skybg.fits.gz&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/Galex/COSMOS_03-fd-int.fits.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;data/Galex/COSMOS_03-fd-skybg.fits.gz&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/Galex/COSMOS_04-nd-int.fits.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;data/Galex/COSMOS_04-nd-skybg.fits.gz&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;data/Galex/COSMOS_04-fd-int.fits.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;data/Galex/COSMOS_04-fd-skybg.fits.gz&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="b-main-function-to-do-the-forced-photometry">
<h3>3b. Main Function to do the Forced Photometry<a class="headerlink" href="#b-main-function-to-do-the-forced-photometry" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_instrflux</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="n">ks_flux_aper2</span><span class="p">,</span> <span class="n">img_pair</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate single-band instrumental fluxes and uncertainties at the given ra, dec</span>
<span class="sd">    using tractor.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    band : `Band`</span>
<span class="sd">        Collection of parameters for a single band.</span>
<span class="sd">        A `Band` is a named tuple with the following attributes:</span>
<span class="sd">            idx : int</span>
<span class="sd">                Identifier for the band/channel.</span>
<span class="sd">                (integer in [0, 1, 2, 3, 4, 5] for the four IRAC bands and two Galex bands)</span>
<span class="sd">            prf : np.ndarray</span>
<span class="sd">                Point spread function for the band/channel.</span>
<span class="sd">            cutout_width : int</span>
<span class="sd">                width of desired cutout in arcseconds</span>
<span class="sd">            flux_conv : float</span>
<span class="sd">                factor used to convert tractor result to microjanskies</span>
<span class="sd">            mosaic_pix_scale : float</span>
<span class="sd">                Pixel scale of the image</span>
<span class="sd">    ra, dec : float</span>
<span class="sd">        celestial coordinates for measuring photometry</span>
<span class="sd">    stype : int</span>
<span class="sd">        0, 1, 2, -9 for star, galaxy, x-ray source</span>
<span class="sd">    ks_flux_aper_2 : float</span>
<span class="sd">        flux in aperture 2</span>
<span class="sd">    img_pair : tuple</span>
<span class="sd">        Pair of images for science and background respectively.</span>
<span class="sd">        If the tuple only contains one element it will serve double duty.</span>
<span class="sd">        A tuple element can be a `fits.ImageHDU` or the path to a FITS file as a `str`.</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Source catalog.</span>
<span class="sd">        Previous arguments (ra, dec, stype, ks_flux_aper_2) come from a single row of this df.</span>
<span class="sd">        However, we must also pass the entire dataframe in order to find nearby sources which are possible contaminates.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    outband : int</span>
<span class="sd">        reflects the input band index for identification purposes</span>
<span class="sd">    flux : float</span>
<span class="sd">        Measured flux in microJansky.</span>
<span class="sd">        NaN if the forced photometery failed.</span>
<span class="sd">    flux_unc : float</span>
<span class="sd">        Flux uncertainty in microJansky, calculated from the tractor results.</span>
<span class="sd">        NaN if the forced photometery failed or if tractor didn&#39;t report a flux variance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cutout a small region around the object of interest</span>
    <span class="n">subimage</span><span class="p">,</span> <span class="n">bkgsubimage</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">subimage_wcs</span> <span class="o">=</span> <span class="n">cutout</span><span class="o">.</span><span class="n">extract_pair</span><span class="p">(</span>
        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">img_pair</span><span class="o">=</span><span class="n">img_pair</span><span class="p">,</span> <span class="n">cutout_width</span><span class="o">=</span><span class="n">band</span><span class="o">.</span><span class="n">cutout_width</span><span class="p">,</span> <span class="n">mosaic_pix_scale</span><span class="o">=</span><span class="n">band</span><span class="o">.</span><span class="n">mosaic_pix_scale</span>
    <span class="p">)</span>

    <span class="c1"># find nearby sources that are possible contaminants</span>
    <span class="n">objsrc</span><span class="p">,</span> <span class="n">nconfsrcs</span> <span class="o">=</span> <span class="n">find_nconfsources</span><span class="p">(</span>
        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="n">ks_flux_aper2</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">band</span><span class="o">.</span><span class="n">cutout_width</span><span class="p">,</span> <span class="n">subimage_wcs</span><span class="p">,</span> <span class="n">df</span>
    <span class="p">)</span>

    <span class="c1"># estimate the background</span>
    <span class="n">skymean</span><span class="p">,</span> <span class="n">skynoise</span> <span class="o">=</span> <span class="n">photometry</span><span class="o">.</span><span class="n">calc_background</span><span class="p">(</span><span class="n">bkgsubimage</span><span class="o">=</span><span class="n">bkgsubimage</span><span class="p">)</span>

    <span class="c1"># do the forced photometry</span>
    <span class="c1"># if tractor fails to converge, just return NaNs</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flux_var</span> <span class="o">=</span> <span class="n">photometry</span><span class="o">.</span><span class="n">run_tractor</span><span class="p">(</span>
            <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">,</span> <span class="n">prf</span><span class="o">=</span><span class="n">band</span><span class="o">.</span><span class="n">prf</span><span class="p">,</span> <span class="n">objsrc</span><span class="o">=</span><span class="n">objsrc</span><span class="p">,</span> <span class="n">skymean</span><span class="o">=</span><span class="n">skymean</span><span class="p">,</span> <span class="n">skynoise</span><span class="o">=</span><span class="n">skynoise</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">TractorError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># convert the results</span>
    <span class="n">microJy_flux</span><span class="p">,</span> <span class="n">microJy_unc</span> <span class="o">=</span> <span class="n">photometry</span><span class="o">.</span><span class="n">interpret_tractor_results</span><span class="p">(</span>
        <span class="n">flux_var</span><span class="o">=</span><span class="n">flux_var</span><span class="p">,</span> <span class="n">flux_conv</span><span class="o">=</span><span class="n">band</span><span class="o">.</span><span class="n">flux_conv</span><span class="p">,</span> <span class="n">objsrc</span><span class="o">=</span><span class="n">objsrc</span><span class="p">,</span> <span class="n">nconfsrcs</span><span class="o">=</span><span class="n">nconfsrcs</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">band</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">microJy_flux</span><span class="p">,</span> <span class="n">microJy_unc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="c-calculate-forced-photometry-with-straightforward-but-slow-method">
<h3>3c. Calculate Forced Photometry with Straightforward but Slow Method<a class="headerlink" href="#c-calculate-forced-photometry-with-straightforward-but-slow-method" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>no longer in use but keeping to demonstrate this capability<br />
as well as the increase in speed when going to parallelization</p></li>
</ul>
</section>
<section id="d-calculate-forced-photometry-parallelization">
<h3>3d. Calculate Forced Photometry - Parallelization<a class="headerlink" href="#d-calculate-forced-photometry-parallelization" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Parallelization: we can either interate over the rows of the dataframe and run the four bands in parallel; or we could zip together the row index, band, ra, dec,</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">paramlist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">all_bands</span><span class="p">:</span>
        <span class="n">img_pair</span> <span class="o">=</span> <span class="n">lookup_img_pair</span><span class="p">(</span><span class="n">sci_bkg_pairs</span><span class="p">,</span> <span class="n">band</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">galex_image</span><span class="p">)</span>  <span class="c1"># file paths only</span>
        <span class="n">paramlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">ks_flux_aper2</span><span class="p">,</span> <span class="n">img_pair</span><span class="p">,</span> <span class="n">df</span><span class="p">]</span>
        <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;paramlist: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">paramlist</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#proove we can do this for one object</span>
<span class="n">calc_instrflux</span><span class="p">(</span><span class="o">*</span><span class="n">paramlist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>

<span class="c1">#same thing, different syntax</span>
<span class="c1"># calc_instrflux(paramlist[0][1], paramlist[0][2], paramlist[0][3], paramlist[0][4], paramlist[0][5], paramlist[0][6])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#wrapper to measure the photometry on a single object, single band</span>
<span class="k">def</span> <span class="nf">calculate_flux</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate flux.&quot;&quot;&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">calc_instrflux</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="c1"># add simple logging</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output/output.log&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span> <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># if results were previously saved to this location, load them</span>
<span class="c1"># else start a pool of workers to calculate results in parallel, and save them here</span>
<span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;output/results_</span><span class="si">{</span><span class="n">radius</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">.npz&#39;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>

<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span>  <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output/output.log&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span> <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calculate_flux</span><span class="p">,</span> <span class="n">paramlist</span><span class="p">)</span>
    <span class="n">dtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Parallel calculation took </span><span class="si">{</span><span class="n">dtime</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## put the results into the main daraframe</span>
<span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="n">idx</span><span class="p">,(</span><span class="n">ich</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">res</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;ch</span><span class="si">{</span><span class="n">ich</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;ch</span><span class="si">{</span><span class="n">ich</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">flux_unc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Count the number of non-zero ch1 fluxes</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parallel calculation: number of ch1 fluxes filled in =&#39;</span><span class="p">,</span>
      <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ch1flux</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="e-cleanup">
<h3>3e. Cleanup<a class="headerlink" href="#e-cleanup" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#had to call the galex flux columns ch5 and ch6</span>
<span class="c1">#fix that by renaming them now</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ch5flux&#39;</span><span class="p">:</span><span class="s1">&#39;nuvflux&#39;</span><span class="p">,</span> <span class="s1">&#39;ch5flux_unc&#39;</span><span class="p">:</span><span class="s1">&#39;nuvflux_unc&#39;</span><span class="p">,</span><span class="s1">&#39;ch6flux&#39;</span><span class="p">:</span><span class="s1">&#39;fuvflux&#39;</span><span class="p">,</span> <span class="s1">&#39;ch6flux_unc&#39;</span><span class="p">:</span><span class="s1">&#39;fuvflux_unc&#39;</span><span class="p">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#When doing a large run of a large area, save the dataframe with the forced photometry</span>
<span class="c1"># so we don&#39;t have to do the forced photometry every time</span>

<span class="n">df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/COSMOS_</span><span class="si">{</span><span class="n">radius</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">arcmin.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#If you are not runnig the forced photometry, then read in the catalog from a previous run</span>

<span class="c1">#df = pd.read_pickle(&#39;output/COSMOS_48.0arcmin.pkl&#39;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="f-plot-to-confirm-our-photometry-results">
<h3>3f. Plot to Confirm our Photometry Results<a class="headerlink" href="#f-plot-to-confirm-our-photometry-results" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>compare to published COSMOS 2015 catalog</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="c1">#plot tractor fluxes vs. catalog splash fluxes</span>
<span class="c1">#should see a straightline with a slope of 1</span>

<span class="c1">#setup to plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">fluxmax</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1">#ch1</span>
<span class="c1">#first shrink the dataframe to only those rows where I have tractor photometry</span>
<span class="n">df_tractor</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">splash_1_flux</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">splash_1_flux</span> <span class="o">&lt;</span> <span class="n">fluxmax</span><span class="p">)]</span> <span class="c1">#200</span>
<span class="c1">#sns.regplot(data = df_tractor, x = &quot;splash_1_flux&quot;, y = &quot;ch1flux&quot;, ax = ax1, robust = True)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">df_tractor</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;splash_1_flux&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;ch1flux&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">)</span>

<span class="c1">#add a diagonal line with y = x</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()]),</span>  <span class="c1"># min of both axes</span>
    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()]),</span>  <span class="c1"># max of both axes</span>
<span class="p">]</span>

<span class="c1"># now plot both limits against eachother</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;COSMOS 2015 flux ($\mu$Jy)&#39;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;tractor flux ($\mu$Jy)&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;IRAC 3.6&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">])</span>


<span class="c1">#ch2</span>
<span class="c1">#first shrink the dataframe to only those rows where I have tractor photometry</span>
<span class="n">df_tractor</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">splash_2_flux</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">splash_2_flux</span> <span class="o">&lt;</span> <span class="n">fluxmax</span><span class="p">)]</span>
<span class="c1">#sns.regplot(data = df_tractor, x = &quot;splash_2_flux&quot;, y = &quot;ch2flux&quot;, ax = ax2, robust = True)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">df_tractor</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;splash_2_flux&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;ch2flux&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax2</span><span class="p">)</span>

<span class="c1">#add a diagonal line with y = x</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()]),</span>  <span class="c1"># min of both axes</span>
    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()]),</span>  <span class="c1"># max of both axes</span>
<span class="p">]</span>

<span class="c1"># now plot both limits against eachother</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;COSMOS 2015 flux ($\mu$Jy)&#39;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;tractor flux ($\mu$Jy)&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;IRAC 4.5&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">])</span>


<span class="c1">#ch3</span>
<span class="c1">#first shrink the dataframe to only those rows where I have tractor photometry</span>
<span class="n">df_tractor</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">splash_3_flux</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">splash_3_flux</span> <span class="o">&lt;</span> <span class="n">fluxmax</span><span class="p">)]</span>

<span class="c1">#sns.regplot(data = df_tractor, x = &quot;splash_3_flux&quot;, y = &quot;ch3flux&quot;, ax = ax3, robust = True)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">df_tractor</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;splash_3_flux&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;ch3flux&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax3</span><span class="p">)</span>

<span class="c1">#add a diagonal line with y = x</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">ax3</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">ax3</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()]),</span>  <span class="c1"># min of both axes</span>
    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ax3</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">ax3</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()]),</span>  <span class="c1"># max of both axes</span>
<span class="p">]</span>

<span class="c1"># now plot both limits against eachother</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;COSMOS 2015 flux ($\mu$Jy)&#39;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;tractor flux ($\mu$Jy)&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;IRAC 5.8&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">])</span>


<span class="c1">#ch4</span>
<span class="c1">#first shrink the dataframe to only those rows where I have tractor photometry</span>
<span class="n">df_tractor</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">splash_4_flux</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">splash_4_flux</span> <span class="o">&lt;</span> <span class="n">fluxmax</span><span class="p">)]</span>

<span class="c1">#sns.regplot(data = df_tractor, x = &quot;splash_4_flux&quot;, y = &quot;ch4flux&quot;, ax = ax4, robust = True)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">df_tractor</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;splash_4_flux&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;ch4flux&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax4</span><span class="p">)</span>

<span class="c1">#add a diagonal line with y = x</span>
<span class="n">lims</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">ax4</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">ax4</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()]),</span>  <span class="c1"># min of both axes</span>
    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ax4</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">ax4</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()]),</span>  <span class="c1"># max of both axes</span>
<span class="p">]</span>

<span class="c1"># now plot both limits against eachother</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">lims</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;COSMOS 2015 flux ($\mu$Jy)&#39;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;tractor flux ($\mu$Jy)&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;IRAC 8.0&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="p">])</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>

<span class="c1">#plt.savefig(&#39;output/flux_comparison.png&#39;)</span>
</pre></div>
</div>
</div>
</div>
<p>Tractor is working for IRAC; Comparison of tractor derived fluxes with COSMOS 2015 fluxes for all four Spitzer IRAC channels.  Blue points represent each object from the subset of the COSMOS 2015 catalog.  The blue line is a linear regression robust fit to the data with uncertainties shown as the light blue wedge.  The black line is a y = x line plotted to guide the eye.</p>
</section>
</section>
<section id="cross-match-our-new-photometry-catalog-with-an-x-ray-archival-catalog">
<h2>4. Cross Match our New Photometry Catalog with an X-ray archival Catalog<a class="headerlink" href="#cross-match-our-new-photometry-catalog-with-an-x-ray-archival-catalog" title="Link to this heading">#</a></h2>
<p>We are using <code class="docutils literal notranslate"><span class="pre">nway</span></code> as the tool to do the cross match (Salvato et al. 2017).
<code class="docutils literal notranslate"><span class="pre">nway</span></code> expects input as two fits table files and outputs a third table file with all the possible matches and their probabilities of being the correct match.  We then sort that catalog and take only the best matches to be the true matches.</p>
<section id="a-retrieve-the-heasarc-catalog">
<h3>4a. Retrieve the HEASARC Catalog<a class="headerlink" href="#a-retrieve-the-heasarc-catalog" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#first get an X-ray catalog from Heasarc</span>
<span class="n">heasarc</span> <span class="o">=</span> <span class="n">Heasarc</span><span class="p">()</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">heasarc</span><span class="o">.</span><span class="n">query_mission_list</span><span class="p">()</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Mission&#39;</span><span class="p">]</span> <span class="o">==</span><span class="s2">&quot;CHANDRA&quot;</span><span class="p">)</span>
<span class="n">chandratable</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1">#find out which tables exist on Heasarc</span>
<span class="c1">#chandratable.pprint(max_lines = 200, max_width = 130)</span>

<span class="c1">#want ccosmoscat</span>
<span class="n">mission</span> <span class="o">=</span> <span class="s1">&#39;ccosmoscat&#39;</span>
<span class="c1">#coords already defined above where I pull the original COSMOS catalog</span>
<span class="n">ccosmoscat_rad</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#radius of chandra cosmos catalog</span>
<span class="n">ccosmoscat</span> <span class="o">=</span> <span class="n">heasarc</span><span class="o">.</span><span class="n">query_region</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">mission</span><span class="o">=</span><span class="n">mission</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="s1">&#39;1 degree&#39;</span><span class="p">,</span> <span class="n">resultmax</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;ALL&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="b-run-nway-to-do-the-cross-match">
<h3>4b. Run <code class="docutils literal notranslate"><span class="pre">nway</span></code> to do the Cross-Match<a class="headerlink" href="#b-run-nway-to-do-the-cross-match" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#setup:</span>

<span class="c1">#astropy doesn&#39;t recognize capitalized units</span>
<span class="c1">#so there might be some warnings here on writing out the file, but we can safely ignore those</span>

<span class="c1">#need to make the chandra catalog into a fits table</span>
<span class="c1">#and needs to include area of the survey.</span>
<span class="n">nway_write_header</span><span class="p">(</span><span class="s1">&#39;data/Chandra/COSMOS_chandra.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;CHANDRA&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">ccosmoscat_rad</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>


<span class="c1">#also need to transform the main pandas dataframe into fits table for nway</span>
<span class="c1">#make an index column for tracking later</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1">#need this to be a fits table and needs to include area of the survey.</span>
<span class="n">rad_in_arcmin</span> <span class="o">=</span> <span class="n">radius</span><span class="o">.</span><span class="n">value</span>  <span class="c1">#units attached to this are confusing nway down the line</span>
<span class="n">nway_write_header</span><span class="p">(</span><span class="s1">&#39;data/multiband_phot.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;OPT&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">rad_in_arcmin</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># call nway</span>
<span class="err">!</span><span class="n">nway</span><span class="o">.</span><span class="n">py</span> <span class="s1">&#39;data/Chandra/COSMOS_chandra.fits&#39;</span> <span class="p">:</span><span class="n">ERROR_RADIUS</span> <span class="s1">&#39;data/multiband_phot.fits&#39;</span> <span class="mf">0.1</span> <span class="o">--</span><span class="n">out</span><span class="o">=</span><span class="n">data</span><span class="o">/</span><span class="n">Chandra</span><span class="o">/</span><span class="n">chandra_multiband</span><span class="o">.</span><span class="n">fits</span> <span class="o">--</span><span class="n">radius</span> <span class="mi">15</span> <span class="o">--</span><span class="n">prior</span><span class="o">-</span><span class="n">completeness</span> <span class="mf">0.9</span>

<span class="c1">#!/opt/conda/bin/nway.py &#39;data/Chandra/COSMOS_chandra.fits&#39; :ERROR_RADIUS &#39;data/multiband_phot.fits&#39; 0.1 --out=data/Chandra/chandra_multiband.fits --radius 15 --prior-completeness 0.9</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Clean up the cross match results and merge them back into main pandas dataframe</span>

<span class="c1">#read in the nway matched catalog</span>
<span class="n">xmatch</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;data/Chandra/chandra_multiband.fits&#39;</span><span class="p">,</span> <span class="n">hdu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df_xmatch</span> <span class="o">=</span> <span class="n">xmatch</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

<span class="c1">#manual suggests that p_i should be greater than 0.1 for a pure catalog.</span>
<span class="c1">#The matched catalog has multiple optical associations for some of the XMM detections.</span>
<span class="c1">#simplest thing to do is only keep match_flag = 1</span>
<span class="n">matched</span> <span class="o">=</span> <span class="n">df_xmatch</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_xmatch</span><span class="p">[</span><span class="s1">&#39;p_i&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df_xmatch</span><span class="p">[</span><span class="s1">&#39;match_flag&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>

<span class="c1">#merge this info back into the df_optical dataframe.</span>
<span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="s1">&#39;outer&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;OPT_ID&#39;</span><span class="p">)</span>

<span class="c1">#remove all the rows which start with &quot;OPT&quot; because they are duplications of the original catalog</span>
<span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;OPT&#39;</span><span class="p">)]</span>

<span class="c1">#somehow the matching is giving negative fluxes in the band where there is no detection</span>
<span class="c1">#if there is a detection in the other band</span>
<span class="c1">#clean that up to make those negative fluxes = 0</span>

<span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;flux_chandra_2_10&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;flux_chandra_2_10&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;flux_chandra_05_2&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;flux_chandra_05_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#How many Chandra sources are there?</span>
<span class="c1">#How many Galex sources are there?</span>

<span class="c1">#make a new column which is a bool of existing chandra measurements</span>
<span class="n">merged</span><span class="p">[</span><span class="s1">&#39;cosmos_chandra_detect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">flux_chandra_2_10</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="s1">&#39;cosmos_chandra_detect&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

<span class="c1">#make one for Galex too</span>
<span class="n">merged</span><span class="p">[</span><span class="s1">&#39;galex_detect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">flux_galex_nuv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span><span class="s1">&#39;galex_detect&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

<span class="c1">#make chandra hardness ratio column:</span>
<span class="c1">#hard = &#39;flux_chandra_2_10&#39;, soft = flux_chandra_05_2, HR = (H-S)/(H+S)</span>
<span class="n">merged</span><span class="p">[</span><span class="s1">&#39;chandra_HR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;flux_chandra_2_10&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;flux_chandra_05_2&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;flux_chandra_2_10&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;flux_chandra_05_2&#39;</span><span class="p">])</span>


<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of Chandra detections =&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">merged</span><span class="o">.</span><span class="n">cosmos_chandra_detect</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of Galex detections =&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">merged</span><span class="o">.</span><span class="n">galex_detect</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="plot-final-results">
<h2>5. Plot Final Results<a class="headerlink" href="#plot-final-results" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>We want to understand something about populations based on their colors</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#IRAC color color plots akin to Lacy et al. 2004</span>
<span class="c1">#overplot galex sources</span>
<span class="c1">#overplot xray sources</span>

<span class="c1">#first select on 24 micron</span>
<span class="n">merged_24</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[(</span><span class="n">merged</span><span class="o">.</span><span class="n">flux_24</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1">#negative Galex fluxes are causing problems, so set those to zero</span>
<span class="n">merged_24</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">merged_24</span><span class="o">.</span><span class="n">fuvflux</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fuvflux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">merged_24</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">merged_24</span><span class="o">.</span><span class="n">nuvflux</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;nuvflux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">#make color columns</span>
<span class="n">merged_24</span><span class="p">[</span><span class="s1">&#39;F5.8divF3.6&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_24</span><span class="o">.</span><span class="n">ch3flux</span> <span class="o">/</span> <span class="n">merged_24</span><span class="o">.</span><span class="n">ch1flux</span>
<span class="n">merged_24</span><span class="p">[</span><span class="s1">&#39;F8.0divF4.5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_24</span><span class="o">.</span><span class="n">ch4flux</span> <span class="o">/</span> <span class="n">merged_24</span><span class="o">.</span><span class="n">ch2flux</span>

<span class="c1">#detected in all IRAC bands</span>
<span class="n">merged_allirac</span> <span class="o">=</span> <span class="n">merged_24</span><span class="p">[(</span><span class="n">merged_24</span><span class="p">[</span><span class="s1">&#39;F8.0divF4.5&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">merged_24</span><span class="p">[</span><span class="s1">&#39;F5.8divF3.6&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>

<span class="c1">#plot all the points</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">merged_allirac</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;F5.8divF3.6&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;F8.0divF4.5&#39;</span><span class="p">,</span>
                 <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>

<span class="c1">#plot only those points with Galex detections</span>
<span class="n">galex_detect</span> <span class="o">=</span> <span class="n">merged_allirac</span><span class="p">[</span><span class="n">merged_allirac</span><span class="o">.</span><span class="n">galex_detect</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">galex_detect</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;F5.8divF3.6&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;F8.0divF4.5&#39;</span><span class="p">,</span>
                 <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Galex detect&#39;</span><span class="p">)</span>

<span class="c1">#plot only those points with chandra detections</span>
<span class="n">chandra_detect</span> <span class="o">=</span> <span class="n">merged_allirac</span><span class="p">[</span><span class="n">merged_allirac</span><span class="o">.</span><span class="n">cosmos_chandra_detect</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">chandra_detect</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;F5.8divF3.6&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;F8.0divF4.5&#39;</span><span class="p">,</span>
                 <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Chandra detect&#39;</span><span class="p">)</span>



<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;log F5.8/F3.6&#39;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;log F8.0/F4.5&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;IRAC Color Color Plot&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This figure shows an IRAC color color plot akin to the seminal work by Lacy et al. 2004.  Points are color coded for those with Galex UV detections and those with Chandra x-ray detections. Note that the different populations are seperating out in this color color space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#UV IR color color plot akin to Bouquin et al. 2015</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">merged</span><span class="p">[</span><span class="s1">&#39;FUV-NUV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">mag_galex_fuv</span> <span class="o">-</span> <span class="n">merged</span><span class="o">.</span><span class="n">mag_galex_nuv</span>
<span class="n">merged</span><span class="p">[</span><span class="s1">&#39;NUV-3.6&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">mag_galex_nuv</span> <span class="o">-</span> <span class="n">merged</span><span class="o">.</span><span class="n">splash_1_mag</span>


<span class="c1">#plot all the points</span>
<span class="c1">#sns.scatterplot(data = merged, x = &#39;NUV-3.6&#39;, y = &#39;FUV-NUV&#39;,</span>
<span class="c1">#                 ax = ax, alpha = 0.5)</span>

<span class="c1">#plot only those points with Galex detections</span>
<span class="n">galex_detect</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">galex_detect</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">galex_detect</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;NUV-3.6&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;FUV-NUV&#39;</span><span class="p">,</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span><span class="c1">#scatterplot , alpha = 0.5</span>

<span class="c1">#plot only those points with chandra detections</span>
<span class="c1">#now with color coding Chandra sources by hardness ratio a la Moutard et al. 2020</span>
<span class="n">chandra_detect</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">cosmos_chandra_detect</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">chandra_detect</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;NUV-3.6&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;FUV-NUV&#39;</span><span class="p">,</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span> <span class="s1">&#39;chandra_HR&#39;</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="s2">&quot;flare&quot;</span><span class="p">)</span>

<span class="c1">#whew that legend for the hue is terrible</span>
<span class="c1">#try making it into a colorbar outside the plot instead</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;chandra_HR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;chandra_HR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;flare&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

<span class="c1"># Remove the legend and add a colorbar</span>
<span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>

<span class="c1">#ax.set(xscale=&quot;log&quot;, yscale=&quot;log&quot;)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;NUV - [3.6]&#39;</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;FUV - NUV&#39;</span><span class="p">)</span>
<span class="c1">#plt.legend([],[], frameon=False)</span>

<span class="c1">#fig.savefig(&quot;output/color_color.png&quot;)</span>
<span class="c1">#mpld3.display(fig)</span>
</pre></div>
</div>
</div>
</div>
<p>We extend the works of Bouquin et al. 2015 and Moutard et al. 2020 by showing a GALEX - Spitzer color color diagram over plotted with Chandra detections.  Blue galaxies in these colors are generated by O and B stars and so must currently be forming stars. We find a tight blue cloud in this color space identifying those star forming galaxies.  Galaxies off of the blue cloud have had their star formation quenched, quite possibly by the existence of an AGN through removal of the gas reservoir required for star formation.  Chandra detected galaxies host AGN, and while those are more limited in number, can be shown here to be a hosted by all kinds of galaxies, including quiescent galaxies which would be in the upper right of this plot.  This likely implies that AGN are indeed involved in quenching star formation.  Additionally, we show the Chandra hardness ratio (HR) color coded according to the vertical color bar on the right side of the plot.  Those AGN with higher hardness ratios have their soft x-ray bands heavily obscured and appear to reside preferentially toward the quiescent galaxies.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<p>This work made use of:</p>
<ul class="simple">
<li><p>Astroquery; Ginsburg et al., 2019, 2019AJ….157…98G</p></li>
<li><p>Astropy; Astropy Collaboration 2022, Astropy Collaboration 2018, Astropy Collaboration 2013, 2022ApJ…935..167A, 2018AJ….156..123A, 2013A&amp;A…558A..33A</p></li>
<li><p>The Tractor; Lang et al. 2016, 2016AJ….151…36L</p></li>
<li><p>Nyland et al. 2017 , 2017ApJS..230….9N</p></li>
<li><p>Salvato et al. 2018, 2018MNRAS.473.4937S</p></li>
<li><p>Laigle et al. 2016, 2016ApJS..224…24L</p></li>
</ul>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="README.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Multi-band forced photometry</p>
      </div>
    </a>
    <a class="right-next"
       href="../light_curves/README.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Time Domain</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input">Input:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#output">Output:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">Authors:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-standard-dependencies">Non-standard Dependencies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieve-initial-catalog-from-irsa">1. Retrieve Initial Catalog from IRSA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-filter-catalog">1a. Filter Catalog</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieve-image-datasets-from-the-cloud">2. Retrieve Image Datasets from the Cloud</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-fornax-cloud-access-api-to-obtain-the-irac-data-from-the-irsa-s3-bucket">Use the fornax cloud access API to obtain the IRAC data from the IRSA S3 bucket.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-ivoa-image-search-and-fornax-download-to-obtain-galex-from-the-mast-archive">Use IVOA image search and Fornax download to obtain Galex from the MAST archive</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-forced-photometry">3.  Run Forced Photometry</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-setup">3a. Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-main-function-to-do-the-forced-photometry">3b. Main Function to do the Forced Photometry</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-calculate-forced-photometry-with-straightforward-but-slow-method">3c. Calculate Forced Photometry with Straightforward but Slow Method</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-calculate-forced-photometry-parallelization">3d. Calculate Forced Photometry - Parallelization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#e-cleanup">3e. Cleanup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f-plot-to-confirm-our-photometry-results">3f. Plot to Confirm our Photometry Results</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-match-our-new-photometry-catalog-with-an-x-ray-archival-catalog">4. Cross Match our New Photometry Catalog with an X-ray archival Catalog</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-retrieve-the-heasarc-catalog">4a. Retrieve the HEASARC Catalog</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-run-nway-to-do-the-cross-match">4b. Run <code class="docutils literal notranslate"><span class="pre">nway</span></code> to do the Cross-Match</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-final-results">5. Plot Final Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Fornax developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024, Fornax developers.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>